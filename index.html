<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA客户管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: #667eea;
        }
        
        .logo-text h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-info .username {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .user-info .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .user-info .logout-btn:hover {
            background: #ff3742;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 10px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: #667eea;
            color: white;
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .content-title {
            font-size: 1.8rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .content-title-icon {
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .action-icons {
            display: flex;
            gap: 10px;
        }
        
        .action-icon {
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .edit-icon {
            color: #17a2b8;
        }
        
        .edit-icon:hover {
            background: #17a2b8;
            color: white;
        }
        
        .delete-icon {
            color: #dc3545;
        }
        
        .delete-icon:hover {
            background: #dc3545;
            color: white;
        }
        
        .reset-icon {
            color: #ffc107;
        }
        
        .reset-icon:hover {
            background: #ffc107;
            color: white;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .import-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .import-options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .import-option {
            flex: 1;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .import-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
        }
        
        .import-option.active {
            border-color: #667eea;
            background: #f0f5ff;
        }
        
        .import-option-icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .import-option-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #333;
        }
        
        .import-option-desc {
            color: #666;
            font-size: 0.9rem;
        }
        
        .import-form {
            margin-top: 30px;
        }
        
        .file-input-container {
            margin-bottom: 20px;
        }
        
        .file-input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .file-input {
            width: 100%;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .import-mode {
            margin-bottom: 20px;
        }
        
        .mode-options {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .preview-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        
        .preview-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .preview-valid {
            color: #28a745;
        }
        
        .preview-invalid {
            color: #dc3545;
        }
        
        .preview-exists {
            color: #ffc107;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.5s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #333;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #333;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .empty-state-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .user-info {
                text-align: center;
            }
            
            .action-buttons {
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <h1>EA客户管理系统</h1>
                    <p>专业的外汇EA客户验证与管理系统</p>
                </div>
            </div>
            <div class="user-info">
                <div class="username" id="username">管理员</div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </button>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 侧边栏 -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('clients')">
                            <i class="fas fa-users nav-icon"></i>
                            <span>客户管理</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('import')">
                            <i class="fas fa-file-import nav-icon"></i>
                            <span>数据导入</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('export')">
                            <i class="fas fa-file-export nav-icon"></i>
                            <span>数据导出</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 客户管理部分 -->
                <div id="clients-section" class="content-section">
                    <div class="content-header">
                        <h2 class="content-title">
                            <i class="fas fa-users content-title-icon"></i>
                            客户列表
                        </h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="openAddModal()">
                                <i class="fas fa-plus"></i> 添加客户
                            </button>
                            <button class="btn btn-info" onclick="showSection('import')">
                                <i class="fas fa-file-import"></i> 导入数据
                            </button>
                            <button class="btn btn-success" onclick="showSection('export')">
                                <i class="fas fa-file-export"></i> 导出数据
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-input" 
                               placeholder="搜索账号ID、服务器、识别码或备注..." 
                               onkeyup="if(event.keyCode===13) searchClients()">
                        <button class="search-btn" onclick="searchClients()">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="clients-table">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>账号ID</th>
                                    <th>服务器</th>
                                    <th>识别码</th>
                                    <th>到期时间</th>
                                    <th>状态</th>
                                    <th>会话数</th>
                                    <th>备注</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="clients-tbody">
                                <!-- 数据会动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="empty-state" id="empty-state" style="display: none;">
                        <div class="empty-state-icon">
                            <i class="fas fa-users-slash"></i>
                        </div>
                        <div class="empty-state-text">暂无客户数据</div>
                        <p>点击"添加客户"按钮创建第一个客户</p>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <!-- 分页会动态生成 -->
                    </div>
                </div>
                
                <!-- 数据导入部分 -->
                <div id="import-section" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">
                            <i class="fas fa-file-import content-title-icon"></i>
                            数据导入
                        </h2>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="showSection('clients')">
                                <i class="fas fa-arrow-left"></i> 返回列表
                            </button>
                        </div>
                    </div>
                    
                    <div class="import-section">
                        <h3 style="margin-bottom: 15px; color: #333;">选择导入方式</h3>
                        <div class="import-options">
                            <div class="import-option active" onclick="selectImportOption('simple')">
                                <div class="import-option-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="import-option-title">简单模板导入</div>
                                <div class="import-option-desc">
                                    使用简化模板（6个字段）<br>
                                    适合批量添加新客户
                                </div>
                            </div>
                            <div class="import-option" onclick="selectImportOption('full')">
                                <div class="import-option-icon">
                                    <i class="fas fa-file-excel"></i>
                                </div>
                                <div class="import-option-title">完整模板导入</div>
                                <div class="import-option-desc">
                                    使用完整模板（10个字段）<br>
                                    兼容导出的CSV文件格式
                                </div>
                            </div>
                        </div>
                        
                        <div class="import-form">
                            <div class="form-group">
                                <label class="form-label">选择导入模板</label>
                                <select class="form-input" id="template-select" onchange="updateImportTemplate()">
                                    <option value="simple">简单模板（6字段）</option>
                                    <option value="full">完整模板（10字段）</option>
                                </select>
                                <button class="btn btn-info" onclick="downloadTemplate()" style="margin-top: 10px;">
                                    <i class="fas fa-download"></i> 下载模板
                                </button>
                            </div>
                            
                            <div class="form-group file-input-container">
                                <label class="form-label" id="file-label">选择CSV文件（支持简单格式）</label>
                                <input type="file" class="form-input file-input" id="csv-file" accept=".csv">
                                <button class="btn btn-warning" onclick="previewImport()" style="margin-top: 10px;">
                                    <i class="fas fa-eye"></i> 预览数据
                                </button>
                            </div>
                            
                            <div class="form-group import-mode">
                                <label class="form-label">导入模式</label>
                                <div class="mode-options">
                                    <label class="mode-option">
                                        <input type="radio" name="import-mode" value="add" checked>
                                        <span>仅添加新记录（跳过已存在的账号）</span>
                                    </label>
                                    <label class="mode-option">
                                        <input type="radio" name="import-mode" value="update">
                                        <span>更新模式（更新已存在的记录）</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="preview-section" style="display: none;">
                                <h4 style="margin-bottom: 15px; color: #333;">数据预览</h4>
                                <div class="table-container">
                                    <table class="preview-table" id="preview-table">
                                        <thead>
                                            <tr id="preview-header">
                                                <!-- 表头会动态生成 -->
                                            </tr>
                                        </thead>
                                        <tbody id="preview-body">
                                            <!-- 预览数据会动态生成 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                    <p><i class="fas fa-info-circle"></i> 预览仅显示前10行数据，验证通过的数据将显示绿色标记。</p>
                                </div>
                            </div>
                            
                            <div class="modal-footer" style="margin-top: 30px; padding: 0; border: none;">
                                <button class="btn btn-primary" onclick="executeImport()" id="import-btn" disabled>
                                    <i class="fas fa-upload"></i> 开始导入
                                </button>
                                <button class="btn btn-warning" onclick="resetImportForm()">
                                    <i class="fas fa-redo"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 数据导出部分 -->
                <div id="export-section" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2 class="content-title">
                            <i class="fas fa-file-export content-title-icon"></i>
                            数据导出
                        </h2>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="showSection('clients')">
                                <i class="fas fa-arrow-left"></i> 返回列表
                            </button>
                        </div>
                    </div>
                    
                    <div class="import-section">
                        <h3 style="margin-bottom: 15px; color: #333;">导出选项</h3>
                        
                        <div class="form-group">
                            <label class="form-label">搜索筛选（可选）</label>
                            <input type="text" class="form-input" id="export-search" 
                                   placeholder="输入关键词筛选要导出的数据...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">导出格式</label>
                            <div class="mode-options">
                                <label class="mode-option">
                                    <input type="radio" name="export-format" value="full" checked>
                                    <span>完整格式（包含所有字段，适合数据备份）</span>
                                </label>
                                <label class="mode-option">
                                    <input type="radio" name="export-format" value="simple">
                                    <span>简化格式（仅业务字段，适合分享）</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="modal-footer" style="margin-top: 30px; padding: 0; border: none;">
                            <button class="btn btn-success" onclick="exportData()">
                                <i class="fas fa-download"></i> 导出数据
                            </button>
                            <button class="btn btn-info" onclick="downloadTemplate('export')">
                                <i class="fas fa-file-download"></i> 下载模板
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑客户模态框 -->
    <div id="client-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    <span id="modal-title">添加新客户</span>
                </h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="client-form">
                    <div class="form-group">
                        <label class="form-label">账号ID *</label>
                        <input type="text" class="form-input" id="account-id" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">服务器 *</label>
                        <input type="text" class="form-input" id="license-key" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">识别码 *</label>
                        <input type="text" class="form-input" id="identification-code" required>
                        <small style="color: #666;">多个识别码用逗号分隔，例如: 123456,654321</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">到期时间 *</label>
                        <input type="date" class="form-input" id="expire-date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">最大会话数</label>
                        <input type="number" class="form-input" id="max-sessions" value="999" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" class="form-checkbox" id="is-active" checked>
                            启用账号
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea class="form-textarea" id="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" onclick="closeModal()">取消</button>
                <button class="btn btn-success" onclick="saveClient()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 通知提示 -->
    <div id="notification" class="notification"></div>
    
    <!-- 加载中 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">处理中...</div>
    </div>
    
    <script>
        // 全局变量
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 20;
        let searchQuery = '';
        let currentClientId = null;
        let importPreviewData = [];
        let importFormat = 'simple';
        let apiBaseUrl = window.location.origin;
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成');
            checkLogin();
            loadClients();
        });
        
        // 检查登录状态
        function checkLogin() {
            const token = localStorage.getItem('admin_token');
            const username = localStorage.getItem('admin_username');
            
            if (!token || !username) {
                // 如果未登录，跳转到登录页
                window.location.href = 'login.html';
            } else {
                document.getElementById('username').textContent = username;
            }
        }
        
        // 退出登录
        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_username');
            window.location.href = 'login.html';
        }
        
        // 切换内容区域
        function showSection(sectionId) {
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // 显示选中的内容区域
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            // 更新导航菜单
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            if (sectionId === 'clients') {
                document.querySelector('.nav-link[onclick*="clients"]').classList.add('active');
                loadClients();
            } else if (sectionId === 'import') {
                document.querySelector('.nav-link[onclick*="import"]').classList.add('active');
            } else if (sectionId === 'export') {
                document.querySelector('.nav-link[onclick*="export"]').classList.add('active');
            }
        }
        
        // 加载客户列表
        function loadClients() {
            showLoading('加载客户数据...');
            
            const token = localStorage.getItem('admin_token');
            let url = `${apiBaseUrl}/api/clients?page=${currentPage}&per_page=${perPage}`;
            
            if (searchQuery) {
                url += `&search=${encodeURIComponent(searchQuery)}`;
            }
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    renderClientsTable(data.clients);
                    renderPagination(data.pagination);
                } else {
                    showNotification('加载客户列表失败: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('加载客户列表错误:', error);
                showNotification('加载客户列表失败', 'error');
            });
        }
        
        // 渲染客户表格
        function renderClientsTable(clients) {
            const tbody = document.getElementById('clients-tbody');
            const emptyState = document.getElementById('empty-state');
            
            if (!clients || clients.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            clients.forEach(client => {
                const statusClass = client.is_active ? 'status-active' : 'status-inactive';
                const statusText = client.is_active ? '正常' : '禁用';
                const sessionText = `${client.current_sessions}/${client.max_sessions}`;
                const createdDate = client.created_at ? client.created_at.split(' ')[0] : '未知';
                
                // 处理识别码显示（如果太长则截断）
                let identificationDisplay = client.identification_code;
                if (identificationDisplay.length > 20) {
                    identificationDisplay = identificationDisplay.substring(0, 20) + '...';
                }
                
                html += `
                    <tr>
                        <td>${client.id}</td>
                        <td>${client.account_id}</td>
                        <td>${client.license_key}</td>
                        <td title="${client.identification_code}">${identificationDisplay}</td>
                        <td>${client.expire_date}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${sessionText}</td>
                        <td title="${client.notes || ''}">${(client.notes || '').substring(0, 20)}${(client.notes || '').length > 20 ? '...' : ''}</td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="action-icons">
                                <i class="fas fa-edit edit-icon action-icon" onclick="editClient('${client.account_id}')" title="编辑"></i>
                                <i class="fas fa-trash delete-icon action-icon" onclick="deleteClient('${client.account_id}')" title="删除"></i>
                                <i class="fas fa-redo reset-icon action-icon" onclick="resetSessions('${client.account_id}')" title="重置会话数"></i>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // 渲染分页
        function renderPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            currentPage = pagination.page;
            totalPages = pagination.pages;
            
            let html = '';
            
            // 上一页按钮
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i>
                     </button>`;
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span class="pagination-btn" style="border: none; background: none;">...</span>`;
                }
            }
            
            // 下一页按钮
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                        <i class="fas fa-chevron-right"></i>
                     </button>`;
            
            // 页面信息
            html += `<span class="page-info">第 ${currentPage} 页，共 ${totalPages} 页，${pagination.total} 条记录</span>`;
            
            paginationDiv.innerHTML = html;
        }
        
        // 跳转到指定页面
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                loadClients();
            }
        }
        
        // 搜索客户
        function searchClients() {
            const searchInput = document.getElementById('search-input');
            searchQuery = searchInput.value.trim();
            currentPage = 1;
            loadClients();
        }
        
        // 打开添加客户模态框
        function openAddModal() {
            currentClientId = null;
            document.getElementById('modal-title').textContent = '添加新客户';
            document.getElementById('client-form').reset();
            document.getElementById('account-id').disabled = false;
            
            // 设置默认到期时间为30天后
            const today = new Date();
            const futureDate = new Date(today);
            futureDate.setDate(today.getDate() + 30);
            document.getElementById('expire-date').value = futureDate.toISOString().split('T')[0];
            
            document.getElementById('client-modal').style.display = 'flex';
        }
        
        // 编辑客户
        function editClient(accountId) {
            showLoading('加载客户信息...');
            
            const token = localStorage.getItem('admin_token');
            fetch(`${apiBaseUrl}/api/client/${accountId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    currentClientId = accountId;
                    document.getElementById('modal-title').textContent = '编辑客户信息';
                    
                    const client = data.client;
                    document.getElementById('account-id').value = client.account_id;
                    document.getElementById('account-id').disabled = true; // 编辑时不能修改账号ID
                    document.getElementById('license-key').value = client.license_key;
                    document.getElementById('identification-code').value = client.identification_code;
                    document.getElementById('expire-date').value = client.expire_date;
                    document.getElementById('max-sessions').value = client.max_sessions;
                    document.getElementById('is-active').checked = client.is_active;
                    document.getElementById('notes').value = client.notes || '';
                    
                    document.getElementById('client-modal').style.display = 'flex';
                } else {
                    showNotification('加载客户信息失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('编辑客户错误:', error);
                showNotification('加载客户信息失败', 'error');
            });
        }
        
        // 保存客户
        function saveClient() {
            const accountId = document.getElementById('account-id').value.trim();
            const licenseKey = document.getElementById('license-key').value.trim();
            const identificationCode = document.getElementById('identification-code').value.trim();
            const expireDate = document.getElementById('expire-date').value;
            const maxSessions = document.getElementById('max-sessions').value;
            const isActive = document.getElementById('is-active').checked;
            const notes = document.getElementById('notes').value.trim();
            
            if (!accountId || !licenseKey || !identificationCode || !expireDate) {
                showNotification('请填写所有必填字段', 'warning');
                return;
            }
            
            const clientData = {
                account_id: accountId,
                license_key: licenseKey,
                identification_code: identificationCode,
                expire_date: expireDate,
                max_sessions: maxSessions,
                is_active: isActive,
                notes: notes
            };
            
            showLoading(currentClientId ? '更新客户信息...' : '添加客户...');
            
            const token = localStorage.getItem('admin_token');
            const url = currentClientId ? 
                `${apiBaseUrl}/api/update/${accountId}` : 
                `${apiBaseUrl}/api/add`;
            const method = currentClientId ? 'POST' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(clientData)
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeModal();
                    loadClients();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('保存客户错误:', error);
                showNotification('保存客户失败', 'error');
            });
        }
        
        // 删除客户
        function deleteClient(accountId) {
            if (!confirm(`确定要删除账号 ${accountId} 吗？此操作不可恢复！`)) {
                return;
            }
            
            showLoading('删除客户...');
            
            const token = localStorage.getItem('admin_token');
            fetch(`${apiBaseUrl}/api/delete/${accountId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadClients();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('删除客户错误:', error);
                showNotification('删除客户失败', 'error');
            });
        }
        
        // 重置会话数
        function resetSessions(accountId) {
            if (!confirm(`确定要重置账号 ${accountId} 的会话数吗？`)) {
                return;
            }
            
            showLoading('重置会话数...');
            
            const token = localStorage.getItem('admin_token');
            fetch(`${apiBaseUrl}/api/reset_sessions/${accountId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadClients();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('重置会话数错误:', error);
                showNotification('重置会话数失败', 'error');
            });
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('client-modal').style.display = 'none';
            currentClientId = null;
        }
        
        // 选择导入选项
        function selectImportOption(option) {
            importFormat = option;
            
            // 更新选项UI
            document.querySelectorAll('.import-option').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.import-option').classList.add('active');
            
            // 更新下拉选择
            document.getElementById('template-select').value = option;
            updateImportTemplate();
        }
        
        // 更新导入模板显示
        function updateImportTemplate() {
            const templateType = document.getElementById('template-select').value;
            importFormat = templateType;
            
            // 更新文件标签
            const fileLabel = document.getElementById('file-label');
            if (templateType === 'simple') {
                fileLabel.textContent = '选择CSV文件（支持简单格式，6个字段）';
            } else {
                fileLabel.textContent = '选择CSV文件（支持完整格式，10个字段）';
            }
            
            // 重置预览
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('import-btn').disabled = true;
        }
        
        // 下载模板
        function downloadTemplate(type = 'import') {
            if (type === 'import') {
                const templateType = document.getElementById('template-select').value;
                const templateUrl = templateType === 'simple' ? 
                    `${apiBaseUrl}/api/export/template` : 
                    `${apiBaseUrl}/api/export/template/full`;
                
                window.open(templateUrl, '_blank');
            } else {
                // 导出页面下载模板
                const format = document.querySelector('input[name="export-format"]:checked').value;
                const templateUrl = format === 'simple' ? 
                    `${apiBaseUrl}/api/export/template` : 
                    `${apiBaseUrl}/api/export/template/full`;
                
                window.open(templateUrl, '_blank');
            }
        }
        
        // 预览导入数据
        function previewImport() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('请先选择CSV文件', 'warning');
                return;
            }
            
            showLoading('预览数据中...');
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            fetch(`${apiBaseUrl}/api/import/preview`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    importPreviewData = data.preview_data;
                    renderImportPreview(data);
                    document.getElementById('preview-section').style.display = 'block';
                    document.getElementById('import-btn').disabled = false;
                    
                    showNotification(`预览成功，共${data.total_rows}行数据，已读取${data.preview_data.length}行`, 'success');
                } else {
                    showNotification('预览失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('预览导入错误:', error);
                showNotification('预览导入失败', 'error');
            });
        }
        
        // 渲染导入预览
        function renderImportPreview(data) {
            const previewHeader = document.getElementById('preview-header');
            const previewBody = document.getElementById('preview-body');
            
            // 清空现有内容
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // 根据格式确定显示的列
            const columns = data.format === 'full' ? 
                ['行号', '账号ID', '服务器', '识别码', '到期时间', '状态', '最大会话数', '当前会话数', '备注', '验证状态'] :
                ['行号', '账号ID', '服务器', '识别码', '到期时间', '状态', '备注', '验证状态'];
            
            // 渲染表头
            let headerHtml = '';
            columns.forEach(col => {
                headerHtml += `<th>${col}</th>`;
            });
            previewHeader.innerHTML = headerHtml;
            
            // 渲染数据行
            let bodyHtml = '';
            data.preview_data.forEach(item => {
                let rowHtml = `<tr>`;
                
                // 行号
                rowHtml += `<td>${item.row}</td>`;
                
                // 账号ID
                rowHtml += `<td>${item.account_id}</td>`;
                
                // 服务器
                rowHtml += `<td>${item.license_key || ''}</td>`;
                
                // 识别码
                let idCode = item.identification_code || '';
                if (idCode.length > 15) {
                    idCode = idCode.substring(0, 15) + '...';
                }
                rowHtml += `<td title="${item.identification_code || ''}">${idCode}</td>`;
                
                // 到期时间
                rowHtml += `<td>${item.expire_date || ''}</td>`;
                
                // 状态
                const statusText = item.is_active ? '正常' : '禁用';
                rowHtml += `<td>${statusText}</td>`;
                
                // 如果是完整格式，添加额外字段
                if (data.format === 'full') {
                    rowHtml += `<td>${item.max_sessions || 999}</td>`;
                    rowHtml += `<td>${item.current_sessions || 0}</td>`;
                }
                
                // 备注
                let notes = item.notes || '';
                if (notes.length > 10) {
                    notes = notes.substring(0, 10) + '...';
                }
                rowHtml += `<td title="${item.notes || ''}">${notes}</td>`;
                
                // 验证状态
                let statusHtml = '';
                if (item.is_valid) {
                    statusHtml = `<span class="preview-valid"><i class="fas fa-check-circle"></i> 有效</span>`;
                    if (item.exists_in_db) {
                        statusHtml += `<br><span class="preview-exists"><i class="fas fa-exclamation-triangle"></i> 已存在</span>`;
                    }
                } else {
                    statusHtml = `<span class="preview-invalid"><i class="fas fa-times-circle"></i> 无效</span>`;
                    if (item.validation_errors && item.validation_errors.length > 0) {
                        statusHtml += `<br><small>${item.validation_errors.join(', ')}</small>`;
                    }
                }
                rowHtml += `<td>${statusHtml}</td>`;
                
                rowHtml += `</tr>`;
                bodyHtml += rowHtml;
            });
            
            previewBody.innerHTML = bodyHtml;
        }
        
        // 执行导入
        function executeImport() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('请先选择CSV文件', 'warning');
                return;
            }
            
            // 检查是否有无效数据
            const invalidCount = importPreviewData.filter(item => !item.is_valid).length;
            if (invalidCount > 0) {
                if (!confirm(`发现${invalidCount}条无效数据，是否继续导入？`)) {
                    return;
                }
            }
            
            showLoading('正在导入数据...');
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            // 添加导入模式
            const importMode = document.querySelector('input[name="import-mode"]:checked').value;
            formData.append('update_mode', importMode === 'update' ? 'true' : 'false');
            
            fetch(`${apiBaseUrl}/api/import/csv`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification(`导入完成！成功导入: ${data.imported}, 跳过: ${data.skipped}, 失败: ${data.failed}`, 'success');
                    
                    // 显示详细结果
                    if (data.results && data.results.length > 0) {
                        let resultMessage = '导入详情:\n';
                        data.results.forEach(result => {
                            resultMessage += `行${result.row}: 账号${result.account_id} - ${result.status} - ${result.message}\n`;
                        });
                        alert(resultMessage);
                    }
                    
                    // 重置表单并刷新客户列表
                    resetImportForm();
                    showSection('clients');
                    loadClients();
                } else {
                    showNotification('导入失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('导入错误:', error);
                showNotification('导入失败', 'error');
            });
        }
        
        // 重置导入表单
        function resetImportForm() {
            document.getElementById('csv-file').value = '';
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('import-btn').disabled = true;
            importPreviewData = [];
        }
        
        // 导出数据
        function exportData() {
            const searchQuery = document.getElementById('export-search').value.trim();
            const format = document.querySelector('input[name="export-format"]:checked').value;
            
            let url = `${apiBaseUrl}/api/export/csv`;
            if (searchQuery) {
                url += `?search=${encodeURIComponent(searchQuery)}`;
                if (format === 'simple') {
                    url += `&format=simple`;
                }
            } else if (format === 'simple') {
                url += `?format=simple`;
            }
            
            window.open(url, '_blank');
            showNotification('导出任务已开始，文件将自动下载', 'info');
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 显示加载中
        function showLoading(text = '处理中...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        // 隐藏加载中
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // 监听键盘事件
        document.addEventListener('keydown', function(event) {
            // ESC键关闭模态框
            if (event.key === 'Escape') {
                closeModal();
            }
            
            // Ctrl+F搜索
            if (event.ctrlKey && event.key === 'f') {
                event.preventDefault();
                document.getElementById('search-input').focus();
            }
        });
    </script>
</body>
</html>