<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAå®¢æˆ·ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* ... åŸæœ‰æ ·å¼ä¿æŒä¸å˜ ... */
        
        /* æ–°å¢æ ·å¼ï¼šæœç´¢åŒºåŸŸ */
        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .search-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .search-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        /* è¡¨æ ¼è°ƒæ•´ */
        th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            padding: 10px 8px;
            text-align: left;
            border-bottom: 2px solid #eaeaea;
            font-size: 13px;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            font-size: 13px;
        }
        
        /* åºå·åˆ—æ ·å¼ */
        .serial-number {
            width: 60px;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* å¤‡æ³¨åˆ—æ ·å¼ */
        .notes-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
        }
        
        .notes-cell:hover {
            overflow: visible;
            white-space: normal;
            background: white;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* æ“ä½œæŒ‰é’®ç»„è°ƒæ•´ */
        .actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            /* å“åº”å¼è°ƒæ•´ */
            .search-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: 100%;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 12px;
            }
            
            .serial-number {
                width: 40px;
            }
            
            .actions {
                flex-direction: column;
                gap: 2px;
            }
            
            .action-btn {
                padding: 3px 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ... ç™»å½•éƒ¨åˆ†ä¿æŒä¸å˜ ... -->
    
    <!-- ä¸»ç³»ç»Ÿç•Œé¢ -->
    <div id="mainContainer">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
            <h1>ğŸ“‹ EAå®¢æˆ·ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ç®¡ç†å®¢æˆ·è´¦å·å’Œåˆ°æœŸæ—¶é—´</p>
        </div>
        
        <!-- ä¸»è¦å†…å®¹ -->
        <div class="content">
            <!-- æ·»åŠ å®¢æˆ·è¡¨å• - æ–°å¢è¯†åˆ«ç å’Œå¤‡æ³¨å­—æ®µ -->
            <div class="section">
                <h2 class="section-title">â• æ·»åŠ æ–°å®¢æˆ·</h2>
                <div id="addAlert" class="alert"></div>
                
                <div class="form-row">
                    <input type="text" id="addAccountId" class="form-control" placeholder="è´¦å·ID (ä¾‹å¦‚: 888888)" required>
                    <input type="text" id="addServer" class="form-control" placeholder="æœåŠ¡å™¨ (ä¾‹å¦‚: ECMarkets-Live04)" required>
                    <input type="text" id="addIdentificationCode" class="form-control" placeholder="è¯†åˆ«ç  (å¯é€‰)">
                </div>
                
                <div class="form-row">
                    <input type="date" id="addExpireDate" class="form-control" required>
                    <select id="addIsActive" class="form-control">
                        <option value="true">æ¿€æ´»çŠ¶æ€</option>
                        <option value="false">ç¦ç”¨çŠ¶æ€</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <textarea id="addNotes" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯ (å¯é€‰)" rows="2" style="resize: vertical;"></textarea>
                </div>
                
                <button onclick="addNewClient()" class="btn">æ·»åŠ å®¢æˆ·</button>
            </div>
            
            <!-- å®¢æˆ·åˆ—è¡¨ -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ‘¥ å®¢æˆ·åˆ—è¡¨</span>
                    <button onclick="loadClients()" class="btn btn-refresh">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                
                <!-- æœç´¢åŒºåŸŸ -->
                <div class="search-section">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢è´¦å·IDã€æœåŠ¡å™¨ã€è¯†åˆ«ç æˆ–å¤‡æ³¨...">
                    <button onclick="searchClients()" class="search-btn">æœç´¢</button>
                    <button onclick="clearSearch()" class="btn" style="background: #95a5a6;">æ¸…é™¤æœç´¢</button>
                </div>
                
                <div id="listAlert" class="alert"></div>
                
                <div id="loading" class="loading">
                    <p>æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...</p>
                </div>
                
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th class="serial-number">åºå·</th>
                            <th>è´¦å·ID</th>
                            <th>æœåŠ¡å™¨</th>
                            <th>è¯†åˆ«ç </th>
                            <th>åˆ°æœŸæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>å¤‡æ³¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="clientsBody">
                        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            
            <!-- ... æµ‹è¯•éªŒè¯éƒ¨åˆ†ä¿æŒä¸å˜ ... -->
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ¨¡æ€æ¡† - æ–°å¢è¯†åˆ«ç å’Œå¤‡æ³¨å­—æ®µ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘å®¢æˆ·ä¿¡æ¯</div>
            <div id="editAlert" class="alert"></div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">è´¦å·ID:</label>
                <input type="text" id="editAccountId" class="form-control" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">æœåŠ¡å™¨:</label>
                <input type="text" id="editServer" class="form-control">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">è¯†åˆ«ç :</label>
                <input type="text" id="editIdentificationCode" class="form-control">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">åˆ°æœŸæ—¶é—´:</label>
                <input type="date" id="editExpireDate" class="form-control">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">çŠ¶æ€:</label>
                <select id="editIsActive" class="form-control">
                    <option value="true">æ¿€æ´»</option>
                    <option value="false">ç¦ç”¨</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">å¤‡æ³¨:</label>
                <textarea id="editNotes" class="form-control" rows="3" style="resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="saveEdit()" class="btn">ä¿å­˜ä¿®æ”¹</button>
                <button onclick="closeEditModal()" class="btn" style="background: #95a5a6;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ... åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†ä¿æŒä¸å˜ ... -->
    
    <script>
        // ========== é…ç½® ==========
        const API_BASE = 'https://islandshen.pythonanywhere.com/api';
        let currentEditClient = null;
        let clientToDelete = null;
        let currentSearchQuery = '';
        
        // ========== ç™»å½•åŠŸèƒ½ - ä¿æŒä¸å˜ ... ==========
        
        // ========== æœç´¢åŠŸèƒ½ ==========
        function searchClients() {
            const searchInput = document.getElementById('searchInput');
            currentSearchQuery = searchInput.value.trim();
            loadClients();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchQuery = '';
            loadClients();
        }
        
        // ========== åŠ è½½å®¢æˆ·åˆ—è¡¨ ==========
        async function loadClients() {
            const loadingDiv = document.getElementById('loading');
            const tbody = document.getElementById('clientsBody');
            
            loadingDiv.style.display = 'block';
            tbody.innerHTML = '';
            
            try {
                // æ„å»ºæŸ¥è¯¢URL
                let url = `${API_BASE}/clients`;
                if (currentSearchQuery) {
                    url += `?search=${encodeURIComponent(currentSearchQuery)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                
                const clients = await response.json();
                
                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #95a5a6;">
                                ğŸ“­ ${currentSearchQuery ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·' : 'æš‚æ— å®¢æˆ·æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ å®¢æˆ·'}
                            </td>
                        </tr>
                    `;
                } else {
                    clients.forEach((client, index) => {
                        const row = createClientRow(client, index + 1);
                        tbody.appendChild(row);
                    });
                }
                
                const searchInfo = currentSearchQuery ? `ï¼ˆæœç´¢: "${currentSearchQuery}"ï¼‰` : '';
                showAlert('listAlert', `å·²åŠ è½½ ${clients.length} ä¸ªå®¢æˆ·${searchInfo}`, 'success');
                
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
                showAlert('listAlert', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #e74c3c;">
                            âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                        </td>
                    </tr>
                `;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // ========== åˆ›å»ºå®¢æˆ·è¡Œ ==========
        function createClientRow(client, serialNumber) {
            const tr = document.createElement('tr');
            
            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            const expireDate = new Date(client.expire_date);
            const now = new Date();
            const isExpired = expireDate < now;
            const isActive = client.is_active;
            
            let statusText, statusClass;
            if (!isActive) {
                statusText = 'å·²ç¦ç”¨';
                statusClass = 'status-inactive';
            } else if (isExpired) {
                statusText = 'å·²è¿‡æœŸ';
                statusClass = 'status-expired';
            } else {
                statusText = 'æ­£å¸¸';
                statusClass = 'status-active';
            }
            
            // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´
            let createdTime = 'æœªçŸ¥';
            if (client.created_at) {
                try {
                    const createdDate = new Date(client.created_at);
                    createdTime = createdDate.toLocaleDateString('zh-CN');
                } catch (e) {
                    createdTime = client.created_at;
                }
            }
            
            // å¤‡æ³¨å¤„ç†ï¼šå¦‚æœä¸ºç©ºæ˜¾ç¤ºå ä½ç¬¦
            const notes = client.notes || '';
            
            tr.innerHTML = `
                <td class="serial-number">${serialNumber}</td>
                <td><strong>${client.account_id}</strong></td>
                <td>${client.license_key || client.server || 'æœªè®¾ç½®'}</td>
                <td>${client.identification_code || '-'}</td>
                <td>${client.expire_date}</td>
                <td><span class="${statusClass}">${statusText}</span></td>
                <td>${createdTime}</td>
                <td class="notes-cell" title="${notes}">${notes || '-'}</td>
                <td>
                    <div class="actions">
                        <button onclick="openEditModal('${client.account_id}')" class="action-btn btn-edit">ç¼–è¾‘</button>
                        <button onclick="toggleClientStatus('${client.account_id}', ${!client.is_active})" class="action-btn ${client.is_active ? 'btn-disable' : 'btn-enable'}">
                            ${client.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button onclick="openDeleteModal('${client.account_id}', '${client.license_key || client.server}')" class="action-btn btn-delete">åˆ é™¤</button>
                    </div>
                </td>
            `;
            
            // å¦‚æœå·²è¿‡æœŸæˆ–ç¦ç”¨ï¼Œæ•´è¡Œå˜ç°
            if (!isActive || isExpired) {
                tr.style.opacity = '0.7';
            }
            
            return tr;
        }
        
        // ========== æ·»åŠ æ–°å®¢æˆ· ==========
        async function addNewClient() {
            const accountId = document.getElementById('addAccountId').value.trim();
            const server = document.getElementById('addServer').value.trim();
            const identificationCode = document.getElementById('addIdentificationCode').value.trim(); // æ–°å¢
            const expireDate = document.getElementById('addExpireDate').value;
            const isActive = document.getElementById('addIsActive').value === 'true';
            const notes = document.getElementById('addNotes').value.trim(); // æ–°å¢
            
            // éªŒè¯è¾“å…¥
            if (!accountId || !server || !expireDate) {
                showAlert('addAlert', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            
            // éªŒè¯è´¦å·IDæ ¼å¼
            if (!/^\d+$/.test(accountId)) {
                showAlert('addAlert', 'è´¦å·IDå¿…é¡»æ˜¯æ•°å­—', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        license_key: server,
                        identification_code: identificationCode, // æ–°å¢
                        expire_date: expireDate,
                        max_sessions: 999,
                        is_active: isActive,
                        notes: notes // æ–°å¢
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('addAlert', 'âœ… å®¢æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('addAccountId').value = '';
                    document.getElementById('addServer').value = '';
                    document.getElementById('addIdentificationCode').value = '';
                    document.getElementById('addNotes').value = '';
                    
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    loadClients();
                } else {
                    showAlert('addAlert', `æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('addAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡† ==========
        async function openEditModal(accountId) {
            try {
                const response = await fetch(`${API_BASE}/clients`);
                const clients = await response.json();
                
                const client = clients.find(c => c.account_id === accountId);
                if (!client) {
                    showAlert('editAlert', 'å®¢æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                currentEditClient = client;
                
                // å¡«å……è¡¨å•
                document.getElementById('editAccountId').value = client.account_id;
                document.getElementById('editServer').value = client.license_key;
                document.getElementById('editIdentificationCode').value = client.identification_code || ''; // æ–°å¢
                document.getElementById('editExpireDate').value = client.expire_date;
                document.getElementById('editIsActive').value = client.is_active.toString();
                document.getElementById('editNotes').value = client.notes || ''; // æ–°å¢
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('editModal').style.display = 'flex';
                
            } catch (error) {
                showAlert('editAlert', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ========== ä¿å­˜ç¼–è¾‘ ==========
        async function saveEdit() {
            if (!currentEditClient) return;
            
            const server = document.getElementById('editServer').value.trim();
            const identificationCode = document.getElementById('editIdentificationCode').value.trim(); // æ–°å¢
            const expireDate = document.getElementById('editExpireDate').value;
            const isActive = document.getElementById('editIsActive').value === 'true';
            const notes = document.getElementById('editNotes').value.trim(); // æ–°å¢
            
            if (!server) {
                showAlert('editAlert', 'æœåŠ¡å™¨ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/update/${currentEditClient.account_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        license_key: server,
                        identification_code: identificationCode, // æ–°å¢
                        expire_date: expireDate,
                        is_active: isActive,
                        notes: notes, // æ–°å¢
                        max_sessions: 999
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('editAlert', 'âœ… ä¿®æ”¹ä¿å­˜æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        closeEditModal();
                        loadClients();
                    }, 1000);
                } else {
                    showAlert('editAlert', `ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('editAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ... å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ ...
        
        // ========== é”®ç›˜å¿«æ·é”® - å¢å¼º ==========
        document.addEventListener('keydown', function(event) {
            // ESC å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
            if (event.key === 'Escape') {
                closeEditModal();
                closeDeleteModal();
            }
            
            // Enteré”®åœ¨ç™»å½•ç•Œé¢ç™»å½•
            if (event.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                login();
            }
            
            // Ctrl+F èšç„¦æœç´¢æ¡†ï¼ˆåœ¨ä¸»ç•Œé¢æ—¶ï¼‰
            if (event.ctrlKey && event.key === 'f' && document.getElementById('mainContainer').style.display !== 'none') {
                event.preventDefault();
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Enteré”®åœ¨æœç´¢æ¡†æœç´¢
            if (event.key === 'Enter' && event.target.id === 'searchInput') {
                searchClients();
            }
        });
        
        // æœç´¢æ¡†å®æ—¶æœç´¢ï¼ˆé˜²æŠ–ï¼‰
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.trim().length >= 2 || this.value.trim().length === 0) {
                    searchClients();
                }
            }, 500);
        });
    </script>
</body>
</html>