<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAå®¢æˆ·è´¦å·ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .api-info {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .api-info code {
            background: #e9ecef;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-control {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        
        .status-expired {
            color: #ffc107;
            font-weight: bold;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“Š EAå®¢æˆ·è´¦å·ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ç®¡ç†å®¢æˆ·çš„è®¸å¯è¯ã€åˆ°æœŸæ—¶é—´å’Œè¿è¡ŒçŠ¶æ€</p>
        </div>
        
        <!-- APIä¿¡æ¯ -->
        <div class="api-info">
            <strong>ğŸ“Œ é‡è¦ä¿¡æ¯ï¼š</strong>
            <p>APIåœ°å€ï¼š<code id="apiUrl">https://islandshen.pythonanywhere.com/api</code></p>
            <p>éªŒè¯æ¥å£ï¼š<code>/api/verify</code> | æ·»åŠ å®¢æˆ·ï¼š<code>/api/add</code></p>
            <div style="margin-top: 10px;">
                <input type="text" id="apiInput" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„APIåœ°å€" style="width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="updateApiUrl()" class="btn" style="padding: 8px 15px; margin-left: 10px;">æ›´æ–°APIåœ°å€</button>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹ -->
        <div class="content">
            <!-- æ·»åŠ å®¢æˆ·è¡¨å• -->
            <div class="section">
                <h2 class="section-title">â• æ·»åŠ æ–°å®¢æˆ·</h2>
                <div id="addAlert" class="alert"></div>
                
                <div class="form-row">
                    <input type="text" id="addAccountId" class="form-control" placeholder="è´¦å·ID (ä¾‹å¦‚: 888888)" required>
                    <input type="text" id="addLicenseKey" class="form-control" placeholder="è®¸å¯è¯å¯†é’¥ (ä¾‹å¦‚: TEST-888888-2024)" required>
                </div>
                
                <div class="form-row">
                    <input type="date" id="addExpireDate" class="form-control" required>
                    <input type="number" id="addMaxSessions" class="form-control" placeholder="æœ€å¤§åŒæ—¶è¿è¡Œæ•°" value="1" min="1">
                    <select id="addIsActive" class="form-control">
                        <option value="true">æ¿€æ´»çŠ¶æ€</option>
                        <option value="false">ç¦ç”¨çŠ¶æ€</option>
                    </select>
                </div>
                
                <button onclick="addNewClient()" class="btn">æ·»åŠ å®¢æˆ·</button>
            </div>
            
            <!-- å®¢æˆ·åˆ—è¡¨ -->
            <div class="section">
                <h2 class="section-title">ğŸ‘¥ å®¢æˆ·åˆ—è¡¨</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="loadClients()" class="btn">åˆ·æ–°åˆ—è¡¨</button>
                    <span id="lastUpdate" style="margin-left: 20px; color: #666; font-size: 14px;"></span>
                </div>
                
                <div id="listAlert" class="alert"></div>
                
                <div id="loading" class="loading">
                    <p>æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...</p>
                </div>
                
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th>è´¦å·ID</th>
                            <th>è®¸å¯è¯</th>
                            <th>åˆ°æœŸæ—¶é—´</th>
                            <th>è¿è¡Œæ•°</th>
                            <th>çŠ¶æ€</th>
                            <th>æœ€åè®¿é—®</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="clientsBody">
                        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            
            <!-- æµ‹è¯•éªŒè¯ -->
            <div class="section">
                <h2 class="section-title">ğŸ§ª æµ‹è¯•éªŒè¯æ¥å£</h2>
                <div id="testAlert" class="alert"></div>
                
                <div class="form-row">
                    <input type="text" id="testAccountId" class="form-control" placeholder="è¾“å…¥è´¦å·IDè¿›è¡Œæµ‹è¯•" value="888888">
                    <input type="text" id="testLicenseKey" class="form-control" placeholder="è¾“å…¥è®¸å¯è¯å¯†é’¥" value="TEST-888888-2024">
                </div>
                
                <button onclick="testVerify()" class="btn">æµ‹è¯•éªŒè¯</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ç¼–è¾‘å®¢æˆ·ä¿¡æ¯</h2>
            <div id="editAlert" class="alert"></div>
            
            <div class="form-group">
                <label>è´¦å·ID:</label>
                <input type="text" id="editAccountId" class="form-control" readonly>
            </div>
            
            <div class="form-group">
                <label>åˆ°æœŸæ—¶é—´:</label>
                <input type="date" id="editExpireDate" class="form-control">
            </div>
            
            <div class="form-group">
                <label>æœ€å¤§è¿è¡Œæ•°:</label>
                <input type="number" id="editMaxSessions" class="form-control" min="1">
            </div>
            
            <div class="form-group">
                <label>çŠ¶æ€:</label>
                <select id="editIsActive" class="form-control">
                    <option value="true">æ¿€æ´»</option>
                    <option value="false">ç¦ç”¨</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEdit()" class="btn">ä¿å­˜ä¿®æ”¹</button>
                <button onclick="closeEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // ========== é…ç½® ==========
        let API_BASE = 'https://islandshen.pythonanywhere.com/api';
        let currentEditClient = null;
        
        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', function() {
            // è‡ªåŠ¨åŠ è½½å®¢æˆ·åˆ—è¡¨
            loadClients();
            
            // è®¾ç½®é»˜è®¤åˆ°æœŸæ—¥æœŸä¸º30å¤©å
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            document.getElementById('addExpireDate').valueAsDate = defaultDate;
            
            // æ˜¾ç¤ºAPIåœ°å€
            document.getElementById('apiUrl').textContent = API_BASE;
        });
        
        // ========== APIåœ°å€æ›´æ–° ==========
        function updateApiUrl() {
            const newUrl = document.getElementById('apiInput').value.trim();
            if (newUrl) {
                // ç¡®ä¿URLä»¥/apiç»“å°¾
                if (!newUrl.endsWith('/api')) {
                    API_BASE = newUrl + '/api';
                } else {
                    API_BASE = newUrl;
                }
                document.getElementById('apiUrl').textContent = API_BASE;
                showAlert('addAlert', `APIåœ°å€å·²æ›´æ–°ä¸º: ${API_BASE}`, 'success');
                // é‡æ–°åŠ è½½æ•°æ®
                loadClients();
            }
        }
        
        // ========== æ˜¾ç¤ºæç¤ºä¿¡æ¯ ==========
        function showAlert(elementId, message, type = 'error') {
            const alertDiv = document.getElementById(elementId);
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }
        
        // ========== åŠ è½½å®¢æˆ·åˆ—è¡¨ ==========
        async function loadClients() {
            const loadingDiv = document.getElementById('loading');
            const tbody = document.getElementById('clientsBody');
            
            loadingDiv.style.display = 'block';
            tbody.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/clients`);
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                
                const clients = await response.json();
                
                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                ğŸ“­ æš‚æ— å®¢æˆ·æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ å®¢æˆ·
                            </td>
                        </tr>
                    `;
                } else {
                    clients.forEach(client => {
                        const row = createClientRow(client);
                        tbody.appendChild(row);
                    });
                }
                
                // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `æœ€ååˆ·æ–°: ${now.toLocaleTimeString('zh-CN')}`;
                
                showAlert('listAlert', `å·²åŠ è½½ ${clients.length} ä¸ªå®¢æˆ·`, 'success');
                
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
                showAlert('listAlert', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // ========== åˆ›å»ºå®¢æˆ·è¡Œ ==========
        function createClientRow(client) {
            const tr = document.createElement('tr');
            
            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            const expireDate = new Date(client.expire_date);
            const now = new Date();
            const isExpired = expireDate < now;
            const isActive = client.is_active;
            
            let statusText, statusClass;
            if (!isActive) {
                statusText = 'å·²ç¦ç”¨';
                statusClass = 'status-inactive';
            } else if (isExpired) {
                statusText = 'å·²è¿‡æœŸ';
                statusClass = 'status-expired';
            } else {
                statusText = 'æ­£å¸¸';
                statusClass = 'status-active';
            }
            
            tr.innerHTML = `
                <td><strong>${client.account_id}</strong></td>
                <td><code>${client.license_key}</code></td>
                <td>${client.expire_date}</td>
                <td>
                    <span style="font-weight: bold; color: ${client.current_sessions >= client.max_sessions ? '#dc3545' : '#28a745'}">
                        ${client.current_sessions}/${client.max_sessions}
                    </span>
                </td>
                <td class="${statusClass}">${statusText}</td>
                <td>${client.last_access || 'ä»æœªè®¿é—®'}</td>
                <td>
                    <div class="actions">
                        <button onclick="openEditModal('${client.account_id}')" class="action-btn" style="background: #007bff; color: white;">ç¼–è¾‘</button>
                        <button onclick="toggleClientStatus('${client.account_id}', ${!client.is_active})" class="action-btn" style="background: ${client.is_active ? '#dc3545' : '#28a745'}; color: white;">
                            ${client.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                    </div>
                </td>
            `;
            
            // å¦‚æœå·²è¿‡æœŸæˆ–ç¦ç”¨ï¼Œæ•´è¡Œå˜ç°
            if (!isActive || isExpired) {
                tr.style.opacity = '0.6';
            }
            
            return tr;
        }
        
        // ========== æ·»åŠ æ–°å®¢æˆ· ==========
        async function addNewClient() {
            const accountId = document.getElementById('addAccountId').value.trim();
            const licenseKey = document.getElementById('addLicenseKey').value.trim();
            const expireDate = document.getElementById('addExpireDate').value;
            const maxSessions = parseInt(document.getElementById('addMaxSessions').value) || 1;
            const isActive = document.getElementById('addIsActive').value === 'true';
            
            // éªŒè¯è¾“å…¥
            if (!accountId || !licenseKey || !expireDate) {
                showAlert('addAlert', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        license_key: licenseKey,
                        expire_date: expireDate,
                        max_sessions: maxSessions,
                        is_active: isActive
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('addAlert', 'âœ… å®¢æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('addAccountId').value = '';
                    document.getElementById('addLicenseKey').value = '';
                    document.getElementById('addMaxSessions').value = '1';
                    
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    loadClients();
                } else {
                    showAlert('addAlert', `æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('addAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡† ==========
        async function openEditModal(accountId) {
            try {
                const response = await fetch(`${API_BASE}/clients`);
                const clients = await response.json();
                
                const client = clients.find(c => c.account_id === accountId);
                if (!client) {
                    showAlert('editAlert', 'å®¢æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                currentEditClient = client;
                
                // å¡«å……è¡¨å•
                document.getElementById('editAccountId').value = client.account_id;
                document.getElementById('editExpireDate').value = client.expire_date;
                document.getElementById('editMaxSessions').value = client.max_sessions;
                document.getElementById('editIsActive').value = client.is_active.toString();
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('editModal').style.display = 'flex';
                
            } catch (error) {
                showAlert('editAlert', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ========== å…³é—­ç¼–è¾‘æ¨¡æ€æ¡† ==========
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditClient = null;
        }
        
        // ========== ä¿å­˜ç¼–è¾‘ ==========
        async function saveEdit() {
            if (!currentEditClient) return;
            
            const expireDate = document.getElementById('editExpireDate').value;
            const maxSessions = parseInt(document.getElementById('editMaxSessions').value);
            const isActive = document.getElementById('editIsActive').value === 'true';
            
            try {
                const response = await fetch(`${API_BASE}/update/${currentEditClient.account_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        expire_date: expireDate,
                        max_sessions: maxSessions,
                        is_active: isActive
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('editAlert', 'âœ… ä¿®æ”¹ä¿å­˜æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        closeEditModal();
                        loadClients();
                    }, 1000);
                } else {
                    showAlert('editAlert', `ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('editAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== åˆ‡æ¢å®¢æˆ·çŠ¶æ€ ==========
        async function toggleClientStatus(accountId, newStatus) {
            if (!confirm(`ç¡®å®šè¦${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}è¿™ä¸ªè´¦å·å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/update/${accountId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_active: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('listAlert', `è´¦å·å·²${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
                    loadClients();
                } else {
                    showAlert('listAlert', `æ“ä½œå¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('listAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== æµ‹è¯•éªŒè¯æ¥å£ ==========
        async function testVerify() {
            const accountId = document.getElementById('testAccountId').value.trim();
            const licenseKey = document.getElementById('testLicenseKey').value.trim();
            
            if (!accountId || !licenseKey) {
                showAlert('testAlert', 'è¯·è¾“å…¥è´¦å·å’Œå¯†é’¥', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        license_key: licenseKey
                    })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    showAlert('testAlert', 
                        `âœ… éªŒè¯æˆåŠŸï¼<br>åˆ°æœŸæ—¶é—´: ${result.expire_date}<br>è¿è¡Œæ•°: ${result.current_sessions}/${result.max_sessions}`, 
                        'success'
                    );
                } else {
                    showAlert('testAlert', `âŒ éªŒè¯å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('testAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== é”®ç›˜å¿«æ·é”® ==========
        document.addEventListener('keydown', function(event) {
            // Ctrl + R åˆ·æ–°åˆ—è¡¨
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                loadClients();
            }
            
            // ESC å…³é—­æ¨¡æ€æ¡†
            if (event.key === 'Escape') {
                closeEditModal();
            }
        });
        
        // ========== è‡ªåŠ¨åˆ·æ–°ï¼ˆå¯é€‰ï¼‰ ==========
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
        setInterval(loadClients, 30000);
    </script>
</body>
</html>