<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAå®¢æˆ·ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* ä¿æŒæ‰€æœ‰åŸæœ‰CSSæ ·å¼ä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .login-header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .login-form {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #f9f9f9;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .login-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        
        .login-alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }
        
        .alert-error {
            background: #fadbd8;
            color: #e74c3c;
            border: 1px solid #f5b7b1;
        }
        
        /* ä¸»ç³»ç»Ÿå®¹å™¨ */
        #mainContainer {
            display: none;
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        /* ... ä¿æŒæ‰€æœ‰å…¶ä»–CSSæ ·å¼ä¸å˜ ... */
        
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-header">
            <h1>ğŸ” EAå®¢æˆ·ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è¯·ç™»å½•ä»¥ç®¡ç†å®¢æˆ·è´¦å·</p>
        </div>
        
        <div class="login-form">
            <div id="loginAlert" class="login-alert"></div>
            
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="islandshen@163.com">
            </div>
            
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " value="Auo_0523">
            </div>
            
            <button onclick="login()" class="login-btn">ç™»å½•</button>
            
            <div style="margin-top: 15px; font-size: 12px; color: #7f8c8d; text-align: center;">
                <p>é»˜è®¤è´¦å·: islandshen@163.com</p>
                <p>é»˜è®¤å¯†ç : Auo_0523</p>
            </div>
        </div>
    </div>
    
    <!-- ä¸»ç³»ç»Ÿç•Œé¢ -->
    <div id="mainContainer">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
            <h1>ğŸ“‹ EAå®¢æˆ·ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ç®¡ç†å®¢æˆ·è´¦å·å’Œåˆ°æœŸæ—¶é—´</p>
        </div>
        
        <!-- ä¸»è¦å†…å®¹ -->
        <div class="content">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-container" id="statsContainer">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- æœç´¢æ  -->
            <div class="search-section">
                <div class="search-title">
                    <span>ğŸ” æœç´¢å®¢æˆ·</span>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" 
                           placeholder="æœç´¢è´¦å·IDã€è¯†åˆ«ç ã€æœåŠ¡å™¨æˆ–å¤‡æ³¨...">
                    <button onclick="searchClients()" class="search-btn">
                        <span>ğŸ”</span> æœç´¢
                    </button>
                    <button onclick="clearSearch()" class="clear-search-btn">æ¸…é™¤æœç´¢</button>
                </div>
            </div>
            
            <!-- æ·»åŠ å®¢æˆ·è¡¨å• -->
            <div class="section">
                <h2 class="section-title">â• æ·»åŠ æ–°å®¢æˆ·</h2>
                <div id="addAlert" class="alert"></div>
                
                <div class="form-row">
                    <input type="text" id="addAccountId" class="form-control" placeholder="è´¦å·ID (ä¾‹å¦‚: 888888)" required>
                    <input type="text" id="addServer" class="form-control" placeholder="æœåŠ¡å™¨ (ä¾‹å¦‚: IC Markets)" required>
                </div>
                
                <div class="form-row">
                    <input type="date" id="addExpireDate" class="form-control" required>
                    <select id="addIsActive" class="form-control">
                        <option value="true">æ¿€æ´»çŠ¶æ€</option>
                        <option value="false">ç¦ç”¨çŠ¶æ€</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <textarea id="addNotes" class="form-control" placeholder="å¤‡æ³¨ä¿¡æ¯ (å¯é€‰)" rows="2"></textarea>
                </div>
                
                <button onclick="addNewClient()" class="btn">æ·»åŠ å®¢æˆ·</button>
            </div>
            
            <!-- å®¢æˆ·åˆ—è¡¨ -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ‘¥ å®¢æˆ·åˆ—è¡¨</span>
                    <button onclick="loadClients()" class="btn btn-refresh">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                
                <div id="listAlert" class="alert"></div>
                
                <div id="loading" class="loading">
                    <p>æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...</p>
                </div>
                
                <div class="table-container">
                    <table id="clientsTable">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>è´¦å·ID</th>
                                <th>è¯†åˆ«ç </th>
                                <th>æœåŠ¡å™¨</th>
                                <th>åˆ°æœŸæ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>å¤‡æ³¨</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="clientsBody">
                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- æµ‹è¯•éªŒè¯ -->
            <div class="section test-section">
                <h2 class="section-title">ğŸ§ª æµ‹è¯•éªŒè¯æ¥å£</h2>
                <div id="testAlert" class="alert"></div>
                
                <div class="form-row">
                    <input type="text" id="testAccountId" class="form-control" placeholder="è¾“å…¥è´¦å·IDè¿›è¡Œæµ‹è¯•" value="888888">
                    <input type="text" id="testServer" class="form-control" placeholder="è¾“å…¥æœåŠ¡å™¨" value="IC Markets">
                </div>
                
                <button onclick="testVerify()" class="btn btn-test">æµ‹è¯•éªŒè¯</button>
                
                <div id="testResult" class="test-result"></div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘å®¢æˆ·ä¿¡æ¯</div>
            <div id="editAlert" class="alert"></div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">è´¦å·ID:</label>
                <input type="text" id="editAccountId" class="form-control" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">è¯†åˆ«ç :</label>
                <input type="text" id="editIdentifier" class="form-control" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">æœåŠ¡å™¨:</label>
                <input type="text" id="editServer" class="form-control">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">åˆ°æœŸæ—¶é—´:</label>
                <input type="date" id="editExpireDate" class="form-control">
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">çŠ¶æ€:</label>
                <select id="editIsActive" class="form-control">
                    <option value="true">æ¿€æ´»</option>
                    <option value="false">ç¦ç”¨</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">å¤‡æ³¨:</label>
                <textarea id="editNotes" class="form-control" rows="3" placeholder="å¤‡æ³¨ä¿¡æ¯"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="saveEdit()" class="btn">ä¿å­˜ä¿®æ”¹</button>
                <button onclick="closeEditModal()" class="btn" style="background: #95a5a6;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            
            <div class="delete-confirm">
                <p style="color: #e74c3c; font-weight: 600; margin-bottom: 10px;">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿ</p>
                <p style="color: #7f8c8d; font-size: 14px;">åºå·: <span id="deleteSeq" style="font-weight: 600;"></span></p>
                <p style="color: #7f8c8d; font-size: 14px;">è´¦å·ID: <span id="deleteAccountId" style="font-weight: 600;"></span></p>
                <p style="color: #7f8c8d; font-size: 14px;">è¯†åˆ«ç : <span id="deleteIdentifier" style="font-weight: 600;"></span></p>
                <p style="color: #7f8c8d; font-size: 14px;">æœåŠ¡å™¨: <span id="deleteServer" style="font-weight: 600;"></span></p>
                <p style="color: #e74c3c; font-size: 13px; margin-top: 15px; border-top: 1px dashed #f8c471; padding-top: 10px;">
                    âš ï¸ æ³¨æ„ï¼šæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼
                </p>
            </div>
            
            <div id="deleteAlert" class="alert"></div>
            
            <div class="delete-actions">
                <button onclick="confirmDelete()" class="btn btn-delete">ç¡®è®¤åˆ é™¤</button>
                <button onclick="closeDeleteModal()" class="btn" style="background: #95a5a6;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // ========== é…ç½® ==========
        // ç›´æ¥æŒ‡å®šAPIè·¯å¾„ - æ ¹æ®æ‚¨çš„å®é™…éƒ¨ç½²åœ°å€ä¿®æ”¹
        const API_BASE = '/api';  // ç›¸å¯¹è·¯å¾„ï¼Œå¦‚æœHTMLå’ŒAPIåœ¨åŒä¸€åŸŸåä¸‹
        
        console.log('å½“å‰é¡µé¢URL:', window.location.href);
        console.log('APIåŸºç¡€è·¯å¾„è®¾ç½®ä¸º:', API_BASE);
        
        let currentEditClient = null;
        let clientToDelete = null;
        let currentSearchTerm = '';
        
        // ========== ç™»å½•åŠŸèƒ½ ==========
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('ç™»å½•ä¿¡æ¯:', { username, password });
            
            if (!username || !password) {
                showLoginAlert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            try {
                const loginUrl = `${API_BASE}/login`;
                console.log('å‘é€ç™»å½•è¯·æ±‚åˆ°:', loginUrl);
                
                const loginData = {
                    username: username,
                    password: password
                };
                console.log('ç™»å½•è¯·æ±‚æ•°æ®:', loginData);
                
                // è°ƒç”¨åç«¯APIè¿›è¡Œç™»å½•éªŒè¯
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });
                
                console.log('ç™»å½•å“åº”çŠ¶æ€:', response.status);
                console.log('ç™»å½•å“åº”URL:', response.url);
                
                const result = await response.json();
                console.log('ç™»å½•å“åº”æ•°æ®:', result);
                
                if (result.success) {
                    // ç™»å½•æˆåŠŸ
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    
                    // è®¾ç½®é»˜è®¤åˆ°æœŸæ—¥æœŸä¸º30å¤©å
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 30);
                    const dateInput = document.getElementById('addExpireDate');
                    if (dateInput) {
                        dateInput.valueAsDate = defaultDate;
                    }
                    
                    // åŠ è½½ç»Ÿè®¡æ•°æ®
                    loadStats();
                    
                    // åŠ è½½å®¢æˆ·åˆ—è¡¨
                    loadClients();
                    
                    showAlert('listAlert', 'ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ä½¿ç”¨ç³»ç»Ÿï¼', 'success');
                } else {
                    showLoginAlert(result.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯è¯¦æƒ…:', error);
                showLoginAlert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥: ' + error.message);
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºæ›´å¤šä¿¡æ¯
                if (error.message.includes('Failed to fetch')) {
                    showLoginAlert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåœ°å€æ˜¯å¦æ­£ç¡®');
                }
            }
        }
        
        function showLoginAlert(message) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.textContent = message;
            alertDiv.className = 'login-alert alert-error';
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
                // ä¸æ¸…é™¤ç”¨æˆ·åå¯†ç ï¼Œæ–¹ä¾¿å†æ¬¡ç™»å½•
                showLoginAlert('å·²é€€å‡ºç™»å½•');
            }
        }
        
        // ========== æµ‹è¯•APIè¿æ¥ ==========
        async function testApiConnection() {
            try {
                const testUrl = `${API_BASE}/test`;
                console.log('æµ‹è¯•APIè¿æ¥:', testUrl);
                
                const response = await fetch(testUrl);
                const result = await response.json();
                console.log('APIæµ‹è¯•ç»“æœ:', result);
                
                return result.status === 'ok';
            } catch (error) {
                console.error('APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        }
        
        // ========== é¡µé¢åŠ è½½æ—¶æµ‹è¯•è¿æ¥ ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            console.log('å½“å‰åŸŸå:', window.location.hostname);
            console.log('å½“å‰åè®®:', window.location.protocol);
            
            // æµ‹è¯•APIè¿æ¥
            const isConnected = await testApiConnection();
            if (!isConnected) {
                showLoginAlert('âš ï¸ APIè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œæ­£å¸¸');
            } else {
                console.log('APIè¿æ¥æ­£å¸¸');
                
                // é¢„å¡«æµ‹è¯•æ•°æ®
                document.getElementById('testAccountId').value = '888888';
                document.getElementById('testServer').value = 'IC Markets';
            }
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            const dateInput = document.getElementById('addExpireDate');
            if (dateInput) {
                dateInput.valueAsDate = defaultDate;
            }
            
            // ç»‘å®šé”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', function(event) {
                // Enteré”®åœ¨ç™»å½•ç•Œé¢ç™»å½•
                if (event.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                    login();
                }
                
                // Enteré”®åœ¨æœç´¢æ¡†æœç´¢
                if (event.key === 'Enter' && document.getElementById('searchInput') === document.activeElement) {
                    searchClients();
                }
                
                // ESC å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
                if (event.key === 'Escape') {
                    closeEditModal();
                    closeDeleteModal();
                }
            });
        });
        
        // ========== æ˜¾ç¤ºæç¤ºä¿¡æ¯ ==========
        function showAlert(elementId, message, type = 'error') {
            const alertDiv = document.getElementById(elementId);
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }
        
        // ========== åŠ è½½ç»Ÿè®¡æ•°æ® ==========
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    const statsContainer = document.getElementById('statsContainer');
                    
                    statsContainer.innerHTML = `
                        <div class="stat-card total-clients">
                            <div class="stat-value">${stats.total}</div>
                            <div class="stat-label">æ€»å®¢æˆ·æ•°</div>
                        </div>
                        <div class="stat-card active-clients">
                            <div class="stat-value">${stats.active}</div>
                            <div class="stat-label">æ­£å¸¸çŠ¶æ€</div>
                        </div>
                        <div class="stat-card disabled-clients">
                            <div class="stat-value">${stats.disabled}</div>
                            <div class="stat-label">ç¦ç”¨çŠ¶æ€</div>
                        </div>
                        <div class="stat-card expired-clients">
                            <div class="stat-value">${stats.expired}</div>
                            <div class="stat-label">å·²è¿‡æœŸ</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // ========== æœç´¢å®¢æˆ· ==========
        function searchClients() {
            const searchInput = document.getElementById('searchInput');
            currentSearchTerm = searchInput.value.trim();
            
            if (currentSearchTerm) {
                showAlert('listAlert', `æ­£åœ¨æœç´¢: "${currentSearchTerm}"`, 'success');
            }
            
            loadClients();
        }
        
        // ========== æ¸…é™¤æœç´¢ ==========
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchTerm = '';
            loadClients();
            showAlert('listAlert', 'æœç´¢å·²æ¸…é™¤', 'success');
        }
        
        // ========== åŠ è½½å®¢æˆ·åˆ—è¡¨ ==========
        async function loadClients() {
            const loadingDiv = document.getElementById('loading');
            const tbody = document.getElementById('clientsBody');
            
            loadingDiv.style.display = 'block';
            tbody.innerHTML = '';
            
            try {
                let url = `${API_BASE}/clients`;
                if (currentSearchTerm) {
                    url += `?search=${encodeURIComponent(currentSearchTerm)}`;
                }
                
                console.log('åŠ è½½å®¢æˆ·åˆ—è¡¨URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                
                const clients = await response.json();
                console.log('è·å–åˆ°çš„å®¢æˆ·æ•°æ®:', clients);
                
                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #95a5a6;">
                                ğŸ“­ ${currentSearchTerm ? 'æœªæ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·' : 'æš‚æ— å®¢æˆ·æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ å®¢æˆ·'}
                            </td>
                        </tr>
                    `;
                } else {
                    // è®¡ç®—èµ·å§‹åºå·ï¼ˆå€’åºæ˜¾ç¤ºï¼‰
                    let seqNumber = clients.length;
                    
                    clients.forEach(client => {
                        const row = createClientRow(client, seqNumber);
                        tbody.appendChild(row);
                        seqNumber--;
                    });
                }
                
                const message = currentSearchTerm 
                    ? `æ‰¾åˆ° ${clients.length} æ¡åŒ¹é…è®°å½•` 
                    : `å·²åŠ è½½ ${clients.length} ä¸ªå®¢æˆ·`;
                showAlert('listAlert', message, 'success');
                
                // é‡æ–°åŠ è½½ç»Ÿè®¡
                loadStats();
                
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
                showAlert('listAlert', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #e74c3c;">
                            âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                        </td>
                    </tr>
                `;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // ========== åˆ›å»ºå®¢æˆ·è¡Œ ==========
        function createClientRow(client, seqNumber) {
            const tr = document.createElement('tr');
            
            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            let isExpired = false;
            try {
                const expireDate = new Date(client.expire_date);
                const now = new Date();
                isExpired = expireDate < now;
            } catch (e) {
                console.error('æ—¥æœŸè§£æé”™è¯¯:', e);
            }
            
            const isActive = client.is_active;
            
            let statusText, statusClass;
            if (!isActive) {
                statusText = 'å·²ç¦ç”¨';
                statusClass = 'status-inactive';
            } else if (isExpired) {
                statusText = 'å·²è¿‡æœŸ';
                statusClass = 'status-expired';
            } else {
                statusText = 'æ­£å¸¸';
                statusClass = 'status-active';
            }
            
            // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´
            let createdTime = 'æœªçŸ¥';
            if (client.created_at) {
                try {
                    const createdDate = new Date(client.created_at);
                    createdTime = createdDate.toLocaleDateString('zh-CN');
                } catch (e) {
                    createdTime = client.created_at;
                }
            }
            
            // å¤‡æ³¨å¤„ç†
            const notes = client.notes || '';
            
            tr.innerHTML = `
                <td>${seqNumber}</td>
                <td><strong>${client.account_id}</strong></td>
                <td class="identifier-cell">${client.identifier || 'N/A'}</td>
                <td>${client.license_key || client.server || 'æœªè®¾ç½®'}</td>
                <td>${client.expire_date}</td>
                <td><span class="${statusClass}">${statusText}</span></td>
                <td class="notes-cell" title="${notes}">${notes || '-'}</td>
                <td>${createdTime}</td>
                <td>
                    <div class="actions">
                        <button onclick="openEditModal('${client.account_id}')" class="action-btn btn-edit">ç¼–è¾‘</button>
                        <button onclick="toggleClientStatus('${client.account_id}', ${!client.is_active})" class="action-btn ${client.is_active ? 'btn-disable' : 'btn-enable'}">
                            ${client.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button onclick="openDeleteModal('${client.id}', '${client.account_id}', '${client.identifier || 'N/A'}', '${client.license_key || client.server}')" class="action-btn btn-delete">åˆ é™¤</button>
                    </div>
                </td>
            `;
            
            // å¦‚æœå·²è¿‡æœŸæˆ–ç¦ç”¨ï¼Œæ•´è¡Œå˜ç°
            if (!isActive || isExpired) {
                tr.style.opacity = '0.7';
            }
            
            return tr;
        }
        
        // ========== æ·»åŠ æ–°å®¢æˆ· ==========
        async function addNewClient() {
            const accountId = document.getElementById('addAccountId').value.trim();
            const server = document.getElementById('addServer').value.trim();
            const expireDate = document.getElementById('addExpireDate').value;
            const isActive = document.getElementById('addIsActive').value === 'true';
            const notes = document.getElementById('addNotes').value.trim();
            
            // éªŒè¯è¾“å…¥
            if (!accountId || !server || !expireDate) {
                showAlert('addAlert', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            
            // éªŒè¯è´¦å·IDæ ¼å¼
            if (!/^\d+$/.test(accountId)) {
                showAlert('addAlert', 'è´¦å·IDå¿…é¡»æ˜¯æ•°å­—', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        license_key: server,
                        expire_date: expireDate,
                        max_sessions: 999,
                        is_active: isActive,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('addAlert', `âœ… å®¢æˆ·æ·»åŠ æˆåŠŸï¼è¯†åˆ«ç : ${result.client.identifier}`, 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('addAccountId').value = '';
                    document.getElementById('addServer').value = '';
                    document.getElementById('addNotes').value = '';
                    
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    loadClients();
                } else {
                    showAlert('addAlert', `æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('addAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡† ==========
        async function openEditModal(accountId) {
            try {
                let url = `${API_BASE}/clients`;
                if (currentSearchTerm) {
                    url += `?search=${encodeURIComponent(currentSearchTerm)}`;
                }
                
                const response = await fetch(url);
                const clients = await response.json();
                
                const client = clients.find(c => c.account_id === accountId);
                if (!client) {
                    showAlert('editAlert', 'å®¢æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                currentEditClient = client;
                
                // å¡«å……è¡¨å•
                document.getElementById('editAccountId').value = client.account_id;
                document.getElementById('editIdentifier').value = client.identifier || 'N/A';
                document.getElementById('editServer').value = client.license_key || client.server;
                document.getElementById('editExpireDate').value = client.expire_date;
                document.getElementById('editIsActive').value = client.is_active.toString();
                document.getElementById('editNotes').value = client.notes || '';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('editModal').style.display = 'flex';
                
            } catch (error) {
                showAlert('editAlert', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ========== å…³é—­ç¼–è¾‘æ¨¡æ€æ¡† ==========
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditClient = null;
        }
        
        // ========== ä¿å­˜ç¼–è¾‘ ==========
        async function saveEdit() {
            if (!currentEditClient) return;
            
            const server = document.getElementById('editServer').value.trim();
            const expireDate = document.getElementById('editExpireDate').value;
            const isActive = document.getElementById('editIsActive').value === 'true';
            const notes = document.getElementById('editNotes').value.trim();
            
            if (!server) {
                showAlert('editAlert', 'æœåŠ¡å™¨ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/update/${currentEditClient.account_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        license_key: server,
                        expire_date: expireDate,
                        is_active: isActive,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('editAlert', 'âœ… ä¿®æ”¹ä¿å­˜æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        closeEditModal();
                        loadClients();
                    }, 1000);
                } else {
                    showAlert('editAlert', `ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('editAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== åˆ‡æ¢å®¢æˆ·çŠ¶æ€ ==========
        async function toggleClientStatus(accountId, newStatus) {
            if (!confirm(`ç¡®å®šè¦${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}è¿™ä¸ªè´¦å·å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/update/${accountId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_active: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('listAlert', `è´¦å·å·²${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
                    loadClients();
                } else {
                    showAlert('listAlert', `æ“ä½œå¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('listAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== æ‰“å¼€åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† ==========
        function openDeleteModal(clientId, accountId, identifier, server) {
            clientToDelete = {
                id: clientId,
                accountId: accountId,
                identifier: identifier,
                server: server
            };
            document.getElementById('deleteSeq').textContent = clientId;
            document.getElementById('deleteAccountId').textContent = accountId;
            document.getElementById('deleteIdentifier').textContent = identifier || 'N/A';
            document.getElementById('deleteServer').textContent = server;
            document.getElementById('deleteModal').style.display = 'flex';
            document.getElementById('deleteAlert').style.display = 'none';
        }
        
        // ========== å…³é—­åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† ==========
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            clientToDelete = null;
        }
        
        // ========== ç¡®è®¤åˆ é™¤å®¢æˆ· ==========
        async function confirmDelete() {
            if (!clientToDelete) return;
            
            try {
                const response = await fetch(`${API_BASE}/delete/${clientToDelete.accountId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('deleteAlert', 'âœ… å®¢æˆ·åˆ é™¤æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        closeDeleteModal();
                        loadClients();
                    }, 1000);
                } else {
                    showAlert('deleteAlert', `åˆ é™¤å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showAlert('deleteAlert', `ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // ========== æµ‹è¯•éªŒè¯æ¥å£ ==========
        async function testVerify() {
            const accountId = document.getElementById('testAccountId').value.trim();
            const server = document.getElementById('testServer').value.trim();
            const testResultDiv = document.getElementById('testResult');
            
            if (!accountId || !server) {
                showAlert('testAlert', 'è¯·è¾“å…¥è´¦å·å’ŒæœåŠ¡å™¨', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        license_key: server
                    })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    testResultDiv.innerHTML = `
                        <div style="background: #d5f4e6; color: #27ae60; padding: 15px; border-radius: 6px; border: 1px solid #a3e4c1;">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">âœ… éªŒè¯æˆåŠŸï¼</div>
                            <div style="font-size: 14px;">
                                <div>è´¦å·ID: <strong>${result.account_id}</strong></div>
                                <div>è¯†åˆ«ç : <strong>${result.identifier || 'N/A'}</strong></div>
                                <div>åˆ°æœŸæ—¶é—´: <strong>${result.expire_date}</strong></div>
                                <div>çŠ¶æ€: <span style="color: #27ae60; font-weight: 600;">æ­£å¸¸</span></div>
                            </div>
                        </div>
                    `;
                    testResultDiv.style.display = 'block';
                } else {
                    testResultDiv.innerHTML = `
                        <div style="background: #fadbd8; color: #e74c3c; padding: 15px; border-radius: 6px; border: 1px solid #f5b7b1;">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">âŒ éªŒè¯å¤±è´¥</div>
                            <div style="font-size: 14px;">é”™è¯¯ä¿¡æ¯: ${result.message}</div>
                        </div>
                    `;
                    testResultDiv.style.display = 'block';
                }
                
            } catch (error) {
                testResultDiv.innerHTML = `
                    <div style="background: #fef5e7; color: #f39c12; padding: 15px; border-radius: 6px; border: 1px solid #f8c471;">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">âš ï¸ ç½‘ç»œé”™è¯¯</div>
                        <div style="font-size: 14px;">${error.message}</div>
                    </div>
                `;
                testResultDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>